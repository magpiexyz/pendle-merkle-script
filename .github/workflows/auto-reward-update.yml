# .github/workflows/auto-reward-update.yml
name: Auto Reward Data Update

on:
  # Triggered when Pull App syncs upstream changes to main
  push:
    branches:
      - main
    paths:
      - 'scripts/data/**'

  # Backup: triggered when Auto Sync workflow completes (if manually run)
  workflow_run:
    workflows: ["Auto Sync from Pendle"]
    types:
      - completed

  # Manual trigger
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  update-rewards:
    runs-on: ubuntu-latest

    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'

    - name: Install Dependencies
      run: yarn install --frozen-lockfile

    - name: Configure AWS Credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::784497868863:role/pendle-merkle-updater
        aws-region: us-west-1
        role-session-name: GitHubActions-RewardUpdate

    - name: Verify AWS Configuration
      run: |
        echo "‚úÖ AWS credentials configured via OIDC"
        aws sts get-caller-identity

    - name: Run Reward Update Script
      id: reward_update
      run: |
        echo "üöÄ Starting reward data update..."
        OUTPUT=$(yarn hardhat run scripts/main-penpie.ts 2>&1)
        echo "$OUTPUT"

        # Extract JSON summary from output
        SUMMARY=$(echo "$OUTPUT" | grep "REWARD_SUMMARY_JSON=" | sed 's/REWARD_SUMMARY_JSON=//')
        echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

        echo "‚úÖ Reward data update completed"

    - name: Send Telegram Notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        SUMMARY='${{ steps.reward_update.outputs.summary }}'

        if [ -z "$SUMMARY" ]; then
          # No summary available (script failed early)
          MESSAGE="‚ùå <b>Pendle Reward Update Failed</b>%0A%0A"
          MESSAGE="${MESSAGE}Workflow: Auto Reward Data Update%0A"
          MESSAGE="${MESSAGE}Status: Script execution failed%0A"
          MESSAGE="${MESSAGE}Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')%0A%0A"
          MESSAGE="${MESSAGE}Please check <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">GitHub Actions</a> for details.%0A%0A"
          MESSAGE="${MESSAGE}cc @cl59821201 @alan_magpie"
        else
          SUCCESS=$(echo "$SUMMARY" | jq -r '.success')
          SKIPPED=$(echo "$SUMMARY" | jq -r '.skipped // false')

          if [ "$SUCCESS" = "true" ] && [ "$SKIPPED" = "true" ]; then
            # Skipped notification (data already exists)
            WEEK_RANGE=$(echo "$SUMMARY" | jq -r '.weekRange')
            TOTAL_REWARD=$(echo "$SUMMARY" | jq -r '.totalReward')
            BASE_REWARD=$(echo "$SUMMARY" | jq -r '.baseReward')
            REWARD_COUNT=$(echo "$SUMMARY" | jq -r '.rewardCount')

            # Convert timestamps to yyyy-mm-dd format
            START_TS=$(echo "$WEEK_RANGE" | cut -d'-' -f1)
            END_TS=$(echo "$WEEK_RANGE" | cut -d'-' -f2)
            START_DATE=$(date -u -d "@$START_TS" '+%Y-%m-%d')
            END_DATE=$(date -u -d "@$END_TS" '+%Y-%m-%d')
            WEEK_RANGE_FORMATTED="${START_DATE} ~ ${END_DATE}"

            # Format rewards (PENDLE uses 6 decimals)
            TOTAL_FORMATTED=$(echo "scale=4; $TOTAL_REWARD / 1000000" | bc)
            BASE_FORMATTED=$(echo "scale=4; $BASE_REWARD / 1000000" | bc)

            MESSAGE="‚ÑπÔ∏è <b>Pendle Reward Update Skipped</b>%0A%0A"
            MESSAGE="${MESSAGE}üìÖ Week Range: <code>${WEEK_RANGE_FORMATTED}</code>%0A"
            MESSAGE="${MESSAGE}üí∞ Total Reward: ${TOTAL_FORMATTED} tokens%0A"
            MESSAGE="${MESSAGE}üéØ Base Reward: ${BASE_FORMATTED} tokens%0A"
            MESSAGE="${MESSAGE}üìä Reward Entries: ${REWARD_COUNT}%0A"
            MESSAGE="${MESSAGE}‚è∞ Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')%0A%0A"
            MESSAGE="${MESSAGE}‚ÑπÔ∏è Data already exists in S3 - no upload needed%0A%0A"
            MESSAGE="${MESSAGE}<a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Workflow</a>%0A%0A"
            MESSAGE="${MESSAGE}cc @cl59821201 @alan_magpie"
          elif [ "$SUCCESS" = "true" ]; then
            # Success notification (new upload)
            WEEK_RANGE=$(echo "$SUMMARY" | jq -r '.weekRange')
            TOTAL_REWARD=$(echo "$SUMMARY" | jq -r '.totalReward')
            BASE_REWARD=$(echo "$SUMMARY" | jq -r '.baseReward')
            REWARD_COUNT=$(echo "$SUMMARY" | jq -r '.rewardCount')

            # Convert timestamps to yyyy-mm-dd format
            START_TS=$(echo "$WEEK_RANGE" | cut -d'-' -f1)
            END_TS=$(echo "$WEEK_RANGE" | cut -d'-' -f2)
            START_DATE=$(date -u -d "@$START_TS" '+%Y-%m-%d')
            END_DATE=$(date -u -d "@$END_TS" '+%Y-%m-%d')
            WEEK_RANGE_FORMATTED="${START_DATE} ~ ${END_DATE}"

            # Format rewards (PENDLE uses 6 decimals)
            TOTAL_FORMATTED=$(echo "scale=4; $TOTAL_REWARD / 1000000" | bc)
            BASE_FORMATTED=$(echo "scale=4; $BASE_REWARD / 1000000" | bc)

            MESSAGE="‚úÖ <b>Pendle Reward Update Successful</b>%0A%0A"
            MESSAGE="${MESSAGE}üìÖ Week Range: <code>${WEEK_RANGE_FORMATTED}</code>%0A"
            MESSAGE="${MESSAGE}üí∞ Total Reward: ${TOTAL_FORMATTED} tokens%0A"
            MESSAGE="${MESSAGE}üéØ Base Reward: ${BASE_FORMATTED} tokens%0A"
            MESSAGE="${MESSAGE}üìä Reward Entries: ${REWARD_COUNT}%0A"
            MESSAGE="${MESSAGE}‚è∞ Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')%0A%0A"
            MESSAGE="${MESSAGE}‚úì Data uploaded to S3%0A"
            MESSAGE="${MESSAGE}‚úì Data uploaded to Dune Analytics%0A%0A"
            MESSAGE="${MESSAGE}<a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Workflow</a>%0A%0A"
            MESSAGE="${MESSAGE}cc @cl59821201 @alan_magpie"
          else
            # Error notification
            ERROR_MSG=$(echo "$SUMMARY" | jq -r '.error')

            MESSAGE="‚ùå <b>Pendle Reward Update Failed</b>%0A%0A"
            MESSAGE="${MESSAGE}Error: ${ERROR_MSG}%0A"
            MESSAGE="${MESSAGE}Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')%0A%0A"
            MESSAGE="${MESSAGE}<a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Logs</a>%0A%0A"
            MESSAGE="${MESSAGE}cc @cl59821201 @alan_magpie"
          fi
        fi

        # Send to Telegram
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="${MESSAGE}" \
          -d parse_mode="HTML"

    - name: Check for Script Errors
      if: failure()
      run: |
        echo "‚ùå Reward update script failed"
        echo "Please check the logs above for error details"
        exit 1
